{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}My Shop{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <!-- CSS global de carrito -->
    <link rel="stylesheet" href="{% static 'carrito/css/cart.css' %}">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="{% url 'home' %}">Leaf an Root</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                {% if user.is_authenticated%}
                    <li class="nav-item">
                        {% if user.is_authenticated and not user.is_staff and not user.is_superuser %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'cart_detail' %}">
                                    Shopping Cart ({{ user.customer.cart.total_items|default:"0" }})
                                </a>
                            </li>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        <form method="post" action="{% url 'logout' %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-link nav-link" style="padding:0; border:none;">Logout</button>
                        </form>
                    </li>
                {% else %}
                    <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'register' %}">Register</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>

<!-- Contenido principal -->

<div class="container mt-4">
    {% block content %}{% endblock %}
</div>

<!-- Sidebar carrito -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartSidebar" aria-labelledby="cartSidebarLabel">
    <div class="offcanvas-header">
        <h5 id="cartSidebarLabel">My shopping cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body" id="cartContent">
        {% if items %}
            <ul class="list-group mb-3">
            {% for item in items %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div class="ms-2 me-auto">
                    <div class="fw-bold">{{ item.product.name }}</div>
                    <form method="post" action="{% url 'update_cart_quantity' item.product.id_product %}">
                        {% csrf_token %}
                        <select name="quantity" class="form-select form-select-sm mt-2" style="width:80px;" onchange="this.form.submit()">
                            {% for i in quantity_range %}
                                <option value="{{ i }}" {% if item.quantity == i %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </form>
                    <small class="text-muted">Price: ${{ item.product.price }}</small><br>
                    <small class="text-muted">Subtotal: ${{ item.get_subtotal }}</small>
                </div>
                <form method="post" action="{% url 'remove_from_cart' item.product.id_product %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">✖</button>
                </form>
            </li>
            {% endfor %}
            </ul>
            <div class="d-flex justify-content-between">
                <strong>Total:</strong> <span>${{ total_price }}</span>
            </div>
            <a href="{% url 'cart_detail' %}" class="btn btn-primary w-100 mt-3">View shopping cart</a>
        {% else %}
            <p>There aren't any items in your shopping cart.</p>
        {% endif %}
    </div>
</div>

<div id="cartOverlay" class="cart-overlay"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'carrito/js/cart.js' %}"></script> <!-- JS global de carrito -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    // Bind para agregar al carrito
    document.querySelectorAll(".add-to-cart-form").forEach(form => {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const url = form.action;
            const formData = new FormData(form);

            const response = await fetch(url, {
                method: "POST",
                body: formData,
                headers: {"X-Requested-With": "XMLHttpRequest"}
            });

            const data = await response.json();
            if (data.success) {
                renderSidebar(data);
            }
        });
    });

    // Renderizar contenido del carrito en sidebar
    function renderSidebar(data) {
        const cartContent = document.getElementById("cartContent");
        cartContent.innerHTML = "";

        let list = document.createElement("ul");
        list.classList.add("list-group", "mb-3");

        data.cart_items.forEach(item => {
            const li = document.createElement("li");
            li.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-start");

            li.innerHTML = `
                <div class="ms-2 me-auto">
                    <div class="fw-bold">${item.name}</div>
                    <form method="post" action="/cart/update/${item.id}/" class="update-form">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie("csrftoken")}">
                        <select name="quantity" class="form-select form-select-sm mt-2" style="width:80px;">
                            ${Array.from({length: 10}, (_, i) => i+1).map(num => `
                                <option value="${num}" ${num === item.quantity ? "selected" : ""}>${num}</option>
                            `).join("")}
                        </select>
                    </form>
                    <small class="text-muted">Precio: $${item.price}</small><br>
                    <small class="text-muted">Subtotal: $${item.subtotal}</small>
                </div>
                <form method="post" action="/cart/remove/${item.id}/" class="remove-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie("csrftoken")}">
                    <button type="submit" class="btn btn-danger btn-sm">✖</button>
                </form>
            `;
            list.appendChild(li);
        });

        cartContent.appendChild(list);

        cartContent.innerHTML += `
            <div class="d-flex justify-content-between">
                <strong>Total:</strong> <span>$${data.total_price}</span>
            </div>
            <a href="/cart/" class="btn btn-primary w-100 mt-3">View shopping cart</a>
        `;

        // Mostrar sidebar
        const sidebarElement = document.getElementById("cartSidebar");
        let sidebar = bootstrap.Offcanvas.getInstance(sidebarElement);
        if (!sidebar) {
            sidebar = new bootstrap.Offcanvas(sidebarElement);
        }
        sidebar.show();

        // Bind dinámico para selects
        bindUpdateForms();
        bindRemoveForms();
    }

    // Manejar cambios de cantidad
    function bindUpdateForms() {
        document.querySelectorAll(".update-form select").forEach(select => {
            select.addEventListener("change", async (e) => {
                e.preventDefault();
                const form = select.closest("form");
                const formData = new FormData(form);

                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: {"X-Requested-With": "XMLHttpRequest"}
                });
                const data = await response.json();
                if (data.success) {
                    renderSidebar(data);
                }
            });
        });
    }

    // Manejar eliminación
    function bindRemoveForms() {
        document.querySelectorAll(".remove-form").forEach(form => {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(form);

                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: {"X-Requested-With": "XMLHttpRequest"}
                });
                const data = await response.json();
                if (data.success) {
                    renderSidebar(data);
                }
            });
        });
    }

    // Helper CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
</body>
</html>
