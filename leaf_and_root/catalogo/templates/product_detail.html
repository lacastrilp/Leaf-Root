
{% load static %}
{% load custom_tags %}
{% load i18n %}
<link rel="stylesheet" href="{% static 'catalogo/css/wishlist.css' %}">
<link rel="stylesheet" href="{% static 'catalogo/css/product_list.css' %}">
<link rel="stylesheet" href="{% static 'catalogo/css/product_detail.css' %}">

{% block content %}
<div class="container mt-4">

  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between mb-2" style="margin-bottom: 2rem; padding-bottom: 1rem;">
    <!-- Bot√≥n izquierda: volver (cierra modal si est√° dentro de uno) -->
    <button type="button" class="btn position-absolute start-0 ms-3" data-bs-dismiss="modal" aria-label="Close">
      <i class="bi bi-arrow-left" style="font-size: 1.5rem;"></i>
    </button>
    <!-- T√≠tulo centrado -->
    <h2 class="productdetail-title mb-0 text-center flex-grow-1">{{ product.name }}</h2>
    <!-- Wishlist derecha -->
    <form method="post" action="{% url 'toggle_wishlist' product.pk %}" 
      class="wishlist-form" data-product-id="{{ product.pk }}">
        {% csrf_token %}
      <button type="submit" class="wishlist-button" aria-label="Toggle wishlist">
        <i class="bi wishlist-icon {% if product.pk in wishlist_product_ids %}bi-heart-fill active{% else %}bi-heart{% endif %}"></i>
        </button>
      </form>
  </div>

  <div class="row g-4">
    <!-- Imagen -->
    <div class="col-12 col-md-5 text-center">
      <div class="product-card d-inline-block">
        {# üè∑Ô∏è Etiqueta dietaria sobre la imagen; muestra siempre que haya valor #}
        {% if product.labels %}
          {% if product.diet_label == "vegan" %}
            <span class="badge vegan product-badge">Vegan</span>
          {% elif product.diet_label == "vegetarian" %}
            <span class="badge vegetarian product-badge">Vegetarian</span>
          {% endif %}
        {% endif %}

        {% if product.image %}
          <img src="{{ product.image.url }}" 
              class="img-fluid rounded shadow-sm w-10 productdetail-im" 
              alt="{{ product.name }}">
        {% elif product.image_url %}
          <img src="{{ product.image_url }}" 
              class="img-fluid rounded shadow-sm w-10 productdetail-im" 
              alt="{{ product.name }}">
        {% else %}
          <img src="https://via.placeholder.com/400" 
              class="img-fluid rounded shadow-sm w-100 productdetail-im"
              alt="No image available">
        {% endif %}
      </div>
    </div>

    <!-- Informaci√≥n -->
    <div class="col-12 col-md-7">
      <!-- Etiqueta dietaria -->
      {# La etiqueta dietaria ahora se muestra sobre la imagen, como en las product cards #}

      <div class="d-flex align-items-center justify-content-between">
        <p class="h4 product-pricee fw-bold mb-0">{% trans "Price" %}: ${{ product.price }}</p>
        <div class="text-end">
          {% if avg_rating %}
            <span class="text-warning"><i class="bi bi-star-fill"></i></span>
            <span class="fw-semibold">{{ avg_rating|floatformat:1 }}/5</span>
            <small class="text-muted">({{ review_count }})</small>
          {% else %}
            <small class="text-muted">{% trans "No ratings yet" %}</small>
          {% endif %}
        </div>
      </div>
      <p><strong>{% trans "Stock" %}:</strong> {{ product.stock }}</p>

      <!-- Alertas de stock -->
      {% if product.stock <= 5 and product.stock > 0 %}
        <div class="alert alert-warning py-1 small">‚ö† {% trans "Only" %} {{ product.stock }} {% trans "units left" %}</div>
      {% elif product.stock == 0 %}
        <div class="alert alert-danger py-1 small">{% trans "Out of stock" %}</div>
      {% endif %}

      <p class="mt-3"><strong>{% trans "Description" %}:</strong><br>{{ product.description }}</p>
      <!-- Bot√≥n a√±adir al carrito -->
      <form method="post" action="{% url 'add_to_cart' product.pk %}?next={% url 'cart_detail' %}" class="mt-2 cart-form d-flex justify-content-center" data-product-id="{{ product.pk }}">
        {% csrf_token %}
        <input type="hidden" name="quantity" value="1">
        <button type="submit" 
            class="btn btn-lg w-90 mx-auto {% if product.stock == 0 %}btn-secondary{% else %}btn-success{% endif %}"
            {% if product.stock == 0 %}disabled{% endif %}>
          <i class="bi bi-cart-plus"></i> {% trans "Add to shopping cart" %}
        </button>
      </form>
    </div>
  </div>
  <!-- Rese√±as -->
  <div class="mt-5">
    <h3 class="productdetail-title">{% trans "Reviews" %}</h3>
    <hr>
    {% for review in reviews %}
      <div class="mb-3 p-3 border rounded shadow-sm bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ review.customer.name }}</strong>
            <span class="text-warning ms-2">
              {% for i in 1|get_range:5 %}
                {% with t=review.rating|star_type:i %}
                  <i class="bi {% if t == 'full' %}bi-star-fill{% elif t == 'half' %}bi-star-half{% else %}bi-star{% endif %}"></i>
                {% endwith %}
              {% endfor %}
            </span>
          </div>

          <!-- Bot√≥n eliminar para admin o para el autor -->
          {% if user.is_authenticated %}
            {% if user.is_staff or user.is_superuser or review.customer.user == user %}
              <form method="post" action="{% url 'delete_review' review.pk %}" class="d-inline delete-review-form" data-review-id="{{ review.pk }}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger">{% trans "Delete" %}</button>
              </form>
            {% endif %}
          {% endif %}
        </div>

        <p class="mb-0 mt-2">{{ review.comment }}</p>
      </div>
    {% empty %}
      <p class="text-muted">{% trans "There aren't any reviews yet." %}</p>
    {% endfor %}
  </div>


  <!-- Formulario para nueva rese√±a -->
  {% if user.is_authenticated %}
    <div class="mt-4">
      <h4>{% trans "Write your review" %}</h4>
      <form method="post" action="{% url 'submit_review' product.pk %}" class="mt-2" id="reviewForm" data-product-id="{{ product.pk }}">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">{% trans "Rating" %}</label>
          <div id="starRating" class="star-rating" aria-label="Rating from 0.5 to 5 stars"></div>
          <input type="hidden" name="rating" id="ratingInput" value="2.5">
        </div>
        <div class="mb-3">
          {{ review_form.comment }}
        </div>
        <button type="submit" class="btn btn-lg btn-success">{% trans "Send review" %}</button>
      </form>
    </div>
  {% else %}
    <p class="mt-3">
      <a href="{% url 'login' %}?next={{ request.path }}">{% trans "Login to write a review" %}</a>
    </p>
  {% endif %}
</div>

<!-- Scripts -->
<script src="{% static 'store/js/product-modal.js' %}"></script>
<script src="{% static 'carrito/js/cart.js' %}"></script>
<script src="{% static 'catalogo/js/wishlist.js' %}"></script>
<script src="{% static 'catalogo/js/reviews.js' %}"></script>
{% endblock %}