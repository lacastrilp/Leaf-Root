
{% load static %}

{% block content %}
<div class="container mt-4">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h2 class="fw-bold mb-2">{{ product.name }}</h2>

    <!-- Wishlist -->
    <form method="post" action="{% url 'toggle_wishlist' product.pk %}" 
          class="wishlist-form ms-auto" data-product-id="{{ product.pk }}">
      {% csrf_token %}
      <button type="submit" class="btn p-0 border-0 bg-transparent">
          <i class="bi wishlist-icon {% if product.id in wishlist_product_ids %}bi-heart-fill text-danger{% else %}bi-heart{% endif %}" 
              style="font-size:1.8rem;"></i>
      </button>
    </form>
  </div>

  <div class="row g-4">
    <!-- Imagen -->
    <div class="col-12 col-md-5 text-center">
      {% if product.image_url %}
        <img src="{{ product.image_url }}" 
             class="img-fluid rounded shadow-sm w-100" 
             style="max-height:400px; object-fit:cover;" 
             alt="{{ product.name }}">
      {% else %}
        <img src="https://via.placeholder.com/400" 
             class="img-fluid rounded shadow-sm w-100" 
             style="max-height:400px; object-fit:cover;" 
             alt="No image available">
      {% endif %}
    </div>

    <!-- Información -->
    <div class="col-12 col-md-7">
      <!-- Etiqueta dietaria -->
      {% if product.diet_label %}
        <span class="badge rounded-pill 
                    {% if product.diet_label == 'vegan' %}bg-success
                    {% elif product.diet_label == 'vegetarian' %}bg-warning text-dark
                    {% endif %} mb-3">
          {{ product.diet_label|title }}
        </span>
      {% endif %}

      <p class="h4 text-primary fw-bold">Price: ${{ product.price }}</p>
      <p><strong>Stock:</strong> {{ product.stock }}</p>

      <!-- Alertas de stock -->
      {% if product.stock <= 5 and product.stock > 0 %}
        <div class="alert alert-warning py-1 small">⚠ Only {{ product.stock }} units left</div>
      {% elif product.stock == 0 %}
        <div class="alert alert-danger py-1 small">Out of stock</div>
      {% endif %}

      <p class="mt-3"><strong>Description:</strong><br>{{ product.description }}</p>

      <!-- Botón añadir al carrito -->
      <form method="post" action="{% url 'add_to_cart' product.pk %}" class="mt-3 cart-form">
          {% csrf_token %}
          <input type="hidden" name="quantity" value="1">
          <button type="submit" class="btn btn-lg w-100 {% if product.stock == 0 %}btn-secondary{% else %}btn-success{% endif %}"
                  {% if product.stock == 0 %}disabled{% endif %}>
            <i class="bi bi-cart-plus"></i> Add to shopping cart
          </button>
      </form>
    </div>
  </div>

  <!-- Reseñas -->
  <div class="mt-5">
    <h3 class="fw-bold">Reviews</h3>
    <hr>
    {% for review in reviews %}
      <div class="mb-3 p-3 border rounded shadow-sm bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ review.customer.name }}</strong>
            <span class="text-warning ms-2">
              {% for i in "12345" %}
                {% if forloop.counter <= review.rating %}
                  ★
                {% else %}
                  ☆
                {% endif %}
              {% endfor %}
            </span>
          </div>

          <!-- Botón eliminar solo para el autor -->
          {% if user.is_authenticated and review.customer == user %}
            <form method="post" action="{% url 'delete_review' review.pk %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          {% endif %}
        </div>

        <p class="mb-0 mt-2">{{ review.comment }}</p>
      </div>
    {% empty %}
      <p class="text-muted">There aren't any reviews yet.</p>
    {% endfor %}
  </div>


  <!-- Formulario para nueva reseña -->
  {% if user.is_authenticated %}
    <div class="mt-4">
      <h4>Write your review</h4>
      <form method="post" action="{% url 'submit_review' product.pk %}" class="mt-2">
        {% csrf_token %}
        {{ review_form.as_p }}
        <button type="submit" class="btn btn-primary">Send review</button>
      </form>
    </div>
  {% else %}
    <p class="mt-3">
      <a href="{% url 'login' %}?next={{ request.path }}">Login to write a review</a>
    </p>
  {% endif %}
</div>

<!-- Scripts -->
<script src="{% static 'store/js/product-modal.js' %}"></script>
<script src="{% static 'carrito/js/cart.js' %}"></script>
<script src="{% static 'catalogo/js/wishlist.js' %}"></script>
{% endblock %}