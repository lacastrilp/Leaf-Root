{% extends "base.html" %}
{% block title %}Cambiar Contrase√±a{% endblock %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'users/css/auth.css' %}">
<link rel="stylesheet" href="{% static 'store/css/base.css' %}">

<style>
.account-bg {
  background-image: url("{% static 'users/images/veggies.jpg' %}");
}
</style>

<div class="auth-bg account-bg">
  <div class="auth-card">
    <a href="{% url 'account_home' %}" class="btn btn-secondary position-absolute" style="top: 0.5rem; left: 2rem;" aria-label="Back to account">
        <i class="bi bi-arrow-left" style="font-size: 1rem;">Back to Account</i>
    </a>
    <h1 class="auth-title">Change Password</h1>
    <form method="post" id="change-password-form">
      {% csrf_token %}
      <div class="mb-3">
        <label for="{{ form.old_password.id_for_label }}" class="form-label">Current Password</label>
        {{ form.old_password }}
        <div id="old-password-feedback" class="form-text"></div>
      </div>
      <div class="mb-3">
        <label for="{{ form.new_password1.id_for_label }}" class="form-label">New Password</label>
        {{ form.new_password1 }}
        <div id="new-password1-feedback" class="form-text"></div>
      </div>
      <div class="mb-3">
        <label for="{{ form.new_password2.id_for_label }}" class="form-label">Confirm New Password</label>
        {{ form.new_password2 }}
        <div id="new-password2-feedback" class="form-text"></div>
      </div>
      <button type="submit" class="btn btn-primary">Change Password</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('change-password-form');
    const oldPassword = document.getElementById('{{ form.old_password.id_for_label }}');
    const newPassword1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const newPassword2 = document.getElementById('{{ form.new_password2.id_for_label }}');
    const oldFeedback = document.getElementById('old-password-feedback');
    const new1Feedback = document.getElementById('new-password1-feedback');
    const new2Feedback = document.getElementById('new-password2-feedback');

    function validatePassword(password) {
        const minLength = 8;
        const hasUpper = /[A-Z]/.test(password);
        const hasLower = /[a-z]/.test(password);
        const hasNumber = /\d/.test(password);
        return password.length >= minLength && hasUpper && hasLower && hasNumber;
    }

    function updateFeedback(input, feedback, isValid, message) {
        input.classList.remove('is-valid', 'is-invalid');
        if (input.value) {
            input.classList.add(isValid ? 'is-valid' : 'is-invalid');
        }
        feedback.textContent = message;
        feedback.className = 'form-text ' + (isValid ? 'text-success' : 'text-danger');
    }

    oldPassword.addEventListener('input', function() {
        if (this.value.length > 0) {
            updateFeedback(this, oldFeedback, true, 'Current password entered.');
        } else {
            updateFeedback(this, oldFeedback, false, 'Please enter your current password.');
        }
    });

    newPassword1.addEventListener('input', function() {
        const isValid = validatePassword(this.value);
        const message = isValid ? 'Password is strong.' : 'Password must be at least 8 characters with uppercase, lowercase, and number.';
        updateFeedback(this, new1Feedback, isValid, message);
        // Also check confirm password
        if (newPassword2.value) {
            const match = this.value === newPassword2.value;
            updateFeedback(newPassword2, new2Feedback, match, match ? 'Passwords match.' : 'Passwords do not match.');
        }
    });

    newPassword2.addEventListener('input', function() {
        const match = this.value === newPassword1.value;
        const message = match ? 'Passwords match.' : 'Passwords do not match.';
        updateFeedback(this, new2Feedback, match, message);
    });
});
</script>
{% endblock %}