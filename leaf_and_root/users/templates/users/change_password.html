{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "Change Password" %}{% endblock %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'users/css/auth.css' %}">
<link rel="stylesheet" href="{% static 'store/css/base.css' %}">

<style>
.account-bg {
  background-image: url("{% static 'users/images/veggies.jpg' %}");
}
</style>

<div class="auth-bg account-bg">
  <div class="auth-card auth-page">
    <a href="{% url 'account_home' %}" class="btn btn-secondary position-absolute" style="top: 0.5rem; left: 2rem;" aria-label="{% trans "Back to account" %}">
        <i class="bi bi-arrow-left" style="font-size: 1rem;">{% trans "Back to Account" %}</i>
    </a>
    <h1 class="auth-title">{% trans "Change Password" %}</h1>
    <form method="post" id="change-password-form">
      {% csrf_token %}
      <div class="mb-3">
        <label for="{{ form.old_password.id_for_label }}" class="form-label">{% trans "Current Password" %}</label>
        {{ form.old_password }}
        <div id="old-password-feedback" class="form-text"></div>
      </div>
      <div class="mb-3">
        <label for="{{ form.new_password1.id_for_label }}" class="form-label">{% trans "New Password" %}</label>
        {{ form.new_password1 }}
        <div id="new-password1-feedback" class="form-text"></div>
      </div>
      <div class="mb-3">
        <label for="{{ form.new_password2.id_for_label }}" class="form-label">{% trans "Confirm New Password" %}</label>
        {{ form.new_password2 }}
        <div id="new-password2-feedback" class="form-text"></div>
      </div>
      <button type="submit" class="btn btn-primary">{% trans "Change Password" %}</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('change-password-form');
    const oldPassword = document.getElementById('{{ form.old_password.id_for_label }}');
    const newPassword1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const newPassword2 = document.getElementById('{{ form.new_password2.id_for_label }}');
    const oldFeedback = document.getElementById('old-password-feedback');
    const new1Feedback = document.getElementById('new-password1-feedback');
    const new2Feedback = document.getElementById('new-password2-feedback');

    function validatePassword(password) {
        const minLength = 8;
        const hasUpper = /[A-Z]/.test(password);
        const hasLower = /[a-z]/.test(password);
        const hasNumber = /\d/.test(password);
        return password.length >= minLength && hasUpper && hasLower && hasNumber;
    }

    function updateFeedback(input, feedback, isValid, message) {
        input.classList.remove('is-valid', 'is-invalid');
        if (input.value) {
            input.classList.add(isValid ? 'is-valid' : 'is-invalid');
        }
        feedback.textContent = message;
        feedback.className = 'form-text ' + (isValid ? 'text-success' : 'text-danger');
    }

    oldPassword.addEventListener('input', function() {
        if (this.value.length > 0) {
            updateFeedback(this, oldFeedback, true, 'Current password entered.');
        } else {
            updateFeedback(this, oldFeedback, false, 'Please enter your current password.');
        }
    });

    newPassword1.addEventListener('input', function() {
        const isValid = validatePassword(this.value);
        const message = isValid ? 'Password is strong.' : 'Password must be at least 8 characters with uppercase, lowercase, and number.';
        updateFeedback(this, new1Feedback, isValid, message);
        // Also check confirm password
        if (newPassword2.value) {
            const match = this.value === newPassword2.value;
            updateFeedback(newPassword2, new2Feedback, match, match ? 'Passwords match.' : 'Passwords do not match.');
        }
    });

    newPassword2.addEventListener('input', function() {
        const match = this.value === newPassword1.value;
        const message = match ? 'Passwords match.' : 'Passwords do not match.';
        updateFeedback(this, new2Feedback, match, message);
    });

    // Password visibility toggle
    try {
      const pwInputs = document.querySelectorAll('.auth-page input[type="password"]');
      const eyeClosedSvg = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M2.47 2.47l19.06 19.06" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.53 9.53a3 3 0 004.24 4.24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 5c4.97 0 9 4.5 9 7s-4.03 7-9 7c-1.31 0-2.55-.25-3.67-.7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      const eyeOpenSvg = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';

      pwInputs.forEach(function (input) {
        const wrapper = document.createElement('div');
        wrapper.className = 'password-toggle';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'toggle-password';
        btn.setAttribute('aria-label', 'Toggle password visibility');
        btn.innerHTML = eyeClosedSvg;
        wrapper.appendChild(btn);

        btn.addEventListener('click', function (e) {
          e.preventDefault();
          if (input.type === 'password') {
            input.type = 'text';
            btn.innerHTML = eyeOpenSvg;
          } else {
            input.type = 'password';
            btn.innerHTML = eyeClosedSvg;
          }
        });
      });
    } catch (err) {
      console.error('Error initializing password toggles', err);
    }
});
</script>
{% endblock %}