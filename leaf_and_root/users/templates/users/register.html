{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load i18n %}
<link rel="stylesheet" href="{% static 'users/css/auth.css' %}">
<link rel="stylesheet" href="{% static 'store/css/base.css' %}">

<div class="auth-bg">
    <div class="auth-card auth-page">
    <h1 class="auth-title">{% trans "Sign up" %}</h1>
    <form method="post" id="registrationForm">
        {% csrf_token %}
        <!-- Username -->
        <div class="mb-3">
            {{ form.username }}
            <span id="username-error" class="text-danger small"></span>
        </div>

        <!-- Email -->
        <div class="mb-3">
            {{ form.email }}
            <span id="email-error" class="text-danger small"></span>
        </div>

        <!-- Password -->
        <div class="mb-3">
            {{ form.password1 }}
            <span id="password1-error" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            {{ form.password2 }}
            <span id="password2-error" class="text-danger small"></span>
        </div>

        <button type="submit" class="btn btn-success" style="width: 300px;">{% trans "Create account" %}</button>
    </form>

    <p class="mt-3 text-center">{% trans "Already have an account?" %}</p>
    <a href="{% url 'login' %}" class="btn btn-secondary" style="width: 300px; align-self: center;">{% trans "Log in here" %}</a>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const usernameInput = document.querySelector("#id_username");
        const emailInput = document.querySelector("#id_email");
        const password1Input = document.querySelector("#id_password1");
        const password2Input = document.querySelector("#id_password2");
        const form = document.querySelector("#registrationForm");

        // --- Función para chequear username/email con AJAX ---
        function checkAvailability(field, value) {
            fetch(`/ajax/check_user_email/?${field}=${encodeURIComponent(value)}`)
                .then(res => res.json())
                .then(data => {
                    const errorSpan = document.querySelector(`#${field}-error`);
                    if(data[`${field}_exists`]){
                        errorSpan.textContent = field === "username" 
                            ? "Este nombre de usuario ya está en uso."
                            : "Este correo electrónico ya está registrado.";
                    } else {
                        errorSpan.textContent = "";
                    }
                });
        }

        // --- Validación de contraseña ---
        function validatePasswords() {
            const error1 = document.querySelector("#password1-error");
            const error2 = document.querySelector("#password2-error");
            let valid = true;

            if(password1Input.value.length < 8){
                error1.textContent = "La contraseña debe tener al menos 8 caracteres.";
                valid = false;
            } else {
                error1.textContent = "";
            }

            if(password2Input.value !== password1Input.value){
                error2.textContent = "Las contraseñas no coinciden.";
                valid = false;
            } else {
                error2.textContent = "";
            }
            return valid;
        }

        // --- Eventos ---
        usernameInput.addEventListener("blur", () => {
            if(usernameInput.value) checkAvailability("username", usernameInput.value);
        });

        emailInput.addEventListener("blur", () => {
            if(emailInput.value) checkAvailability("email", emailInput.value);
        });

        password1Input.addEventListener("input", validatePasswords);
        password2Input.addEventListener("input", validatePasswords);

        // --- Evitar envío si hay errores ---
        form.addEventListener("submit", function(e){
            let hasErrors = false;

            if(document.querySelector("#username-error").textContent) hasErrors = true;
            if(document.querySelector("#email-error").textContent) hasErrors = true;
            if(!validatePasswords()) hasErrors = true;

            if(hasErrors) e.preventDefault();
        });
    });

    // Password visibility toggle with sync for both password fields
    try {
      const pwInputs = document.querySelectorAll('.auth-page input[type="password"]');
      const eyeClosedSvg = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M2.47 2.47l19.06 19.06" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.53 9.53a3 3 0 004.24 4.24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 5c4.97 0 9 4.5 9 7s-4.03 7-9 7c-1.31 0-2.55-.25-3.67-.7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      const eyeOpenSvg = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';

      const toggleButtons = [];

      pwInputs.forEach(function (input) {
        const wrapper = document.createElement('div');
        wrapper.className = 'password-toggle';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'toggle-password';
        btn.setAttribute('aria-label', 'Toggle password visibility');
        btn.innerHTML = eyeClosedSvg;
        wrapper.appendChild(btn);
        toggleButtons.push({btn, input});

        btn.addEventListener('click', function (e) {
          e.preventDefault();
          const newType = input.type === 'password' ? 'text' : 'password';
          const newIcon = newType === 'text' ? eyeOpenSvg : eyeClosedSvg;
          
          // Sync all password fields in register form
          toggleButtons.forEach(function(item) {
            item.input.type = newType;
            item.btn.innerHTML = newIcon;
          });
        });
      });
    } catch (err) {
      console.error('Error initializing password toggles', err);
    }
</script>
{% endblock %}
